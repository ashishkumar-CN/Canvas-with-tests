name: Deploy Backend to EC2

# Trigger this workflow when code is pushed
on:
  push:
    # Only run when backend or docker-compose changes
    paths:
      - "backend/**"
      - "docker-compose.yml"

jobs:
  deploy:
    # GitHub provides a Linux runner
    runs-on: ubuntu-latest

    steps:
    # Step 1: Pull repository code into the runner
    - name: Checkout code
      uses: actions/checkout@v4

    # Step 2: Configure SSH so GitHub can connect to EC2
    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    # Step 3: Connect to EC2 and redeploy backend container
    - name: Deploy on EC2
      run: |
        ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
          cd /home/ubuntu/app
          docker-compose stop backend
          docker-compose rm -f backend
          docker-compose build backend
          docker-compose up -d backend
        EOF
